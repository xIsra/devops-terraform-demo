name: Build Service
on:
  workflow_dispatch:
    inputs:
      service:
        description: "Service to build"
        type: choice
        options: [server, web, resume-agent, migration]
        required: true
      version:
        description: "Image version/tag"
        type: string
        default: "latest"

env:
  SERVICE: ${{ github.event.inputs.service }}
  VERSION: ${{ github.event.inputs.version || 'latest' }}

jobs:
  build-service:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "v1.29.2"

      - name: Configure kubectl for remote cluster
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" > ~/.kube/config
          chmod 600 ~/.kube/config
          kubectl config use-context kind-devops-demo || kubectl config current-context

      - name: Verify Docker registry is accessible
        run: |
          # Verify Docker registry is accessible
          REGISTRY_URL="localhost:5555"
          if ! curl -f http://${REGISTRY_URL}/v2/ >/dev/null 2>&1; then
            echo "Error: Docker registry not accessible at http://${REGISTRY_URL}"
            echo "Please ensure Docker registry is running: docker-compose -f docker-compose.registry.yml up -d"
            exit 1
          fi
          echo "✅ Docker registry is accessible"

      - name: Build resume-agent
        if: env.SERVICE == 'resume-agent'
        run: |
          cd python/resume-agent
          docker build -t resume-agent:${{ env.VERSION }} .
          echo "Built resume-agent:${{ env.VERSION }}"

      - name: Build server
        if: env.SERVICE == 'server'
        run: |
          cd typescript
          docker build -t server:${{ env.VERSION }} -f apps/server/Dockerfile .
          echo "Built server:${{ env.VERSION }}"

      - name: Build migration
        if: env.SERVICE == 'migration'
        run: |
          docker build -t server-migration:${{ env.VERSION }} -f typescript/apps/server/Dockerfile.migration typescript
          echo "Built server-migration:${{ env.VERSION }}"

      - name: Build web
        if: env.SERVICE == 'web'
        run: |
          cd typescript
          docker build -t web:${{ env.VERSION }} -f apps/web/Dockerfile \
            --build-arg VITE_SERVER_URL=https://devops-demo.local/api .
          echo "Built web:${{ env.VERSION }}"

      - name: Push image to image registry
        run: |
          # Get image registry URL (default to production namespace)
          ENV_DIR="infra/envs/production"
          cd "$ENV_DIR"
          terraform init
          REGISTRY_URL=$(terraform output -raw registry_url || echo "localhost:5555")
          REPO_PREFIX="devops-demo-production"

          # Docker registry doesn't require authentication for localhost
          # If registry requires auth, uncomment and configure:
          # echo "YOUR_PASSWORD" | docker login ${REGISTRY_URL} --username YOUR_USERNAME --password-stdin

          case "${{ env.SERVICE }}" in
            resume-agent)
              docker tag resume-agent:${{ env.VERSION }} ${REGISTRY_URL}/${REPO_PREFIX}/resume-agent:${{ env.VERSION }}
              docker push ${REGISTRY_URL}/${REPO_PREFIX}/resume-agent:${{ env.VERSION }}
              ;;
            server)
              docker tag server:${{ env.VERSION }} ${REGISTRY_URL}/${REPO_PREFIX}/server:${{ env.VERSION }}
              docker push ${REGISTRY_URL}/${REPO_PREFIX}/server:${{ env.VERSION }}
              ;;
            migration)
              docker tag server-migration:${{ env.VERSION }} ${REGISTRY_URL}/${REPO_PREFIX}/server-migration:${{ env.VERSION }}
              docker push ${REGISTRY_URL}/${REPO_PREFIX}/server-migration:${{ env.VERSION }}
              ;;
            web)
              docker tag web:${{ env.VERSION }} ${REGISTRY_URL}/${REPO_PREFIX}/web:${{ env.VERSION }}
              docker push ${REGISTRY_URL}/${REPO_PREFIX}/web:${{ env.VERSION }}
              ;;
          esac

          echo "✅ Pushed ${{ env.SERVICE }}:${{ env.VERSION }} to Docker registry"
