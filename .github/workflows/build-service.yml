name: Build Service
on:
  workflow_dispatch:
    inputs:
      service:
        description: "Service to build"
        type: choice
        options: [server, web, resume-agent, migration]
        required: true
      version:
        description: "Image version/tag"
        type: string
        default: "latest"

env:
  SERVICE: ${{ github.event.inputs.service }}
  VERSION: ${{ github.event.inputs.version || 'latest' }}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build resume-agent
        if: env.SERVICE == 'resume-agent'
        run: |
          cd python/resume-agent
          docker build -t resume-agent:${{ env.VERSION }} .
          echo "Built resume-agent:${{ env.VERSION }}"

      - name: Build server
        if: env.SERVICE == 'server'
        run: |
          cd typescript
          docker build -t server:${{ env.VERSION }} -f apps/server/Dockerfile .
          echo "Built server:${{ env.VERSION }}"

      - name: Build migration
        if: env.SERVICE == 'migration'
        run: |
          docker build -t server-migration:${{ env.VERSION }} -f typescript/apps/server/Dockerfile.migration typescript
          echo "Built server-migration:${{ env.VERSION }}"

      - name: Build web
        if: env.SERVICE == 'web'
        run: |
          cd typescript
          docker build -t web:${{ env.VERSION }} -f apps/web/Dockerfile \
            --build-arg VITE_SERVER_URL=https://devops-demo.local/api .
          echo "Built web:${{ env.VERSION }}"

      - name: Load image into Kind cluster
        run: |
          CLUSTER_NAME=${CLUSTER_NAME:-devops-demo}
          if kind get clusters 2>/dev/null | grep -q "^${CLUSTER_NAME}$"; then
            case "${{ env.SERVICE }}" in
              resume-agent)
                kind load docker-image resume-agent:${{ env.VERSION }} --name ${CLUSTER_NAME}
                ;;
              server)
                kind load docker-image server:${{ env.VERSION }} --name ${CLUSTER_NAME}
                ;;
              migration)
                kind load docker-image server-migration:${{ env.VERSION }} --name ${CLUSTER_NAME}
                ;;
              web)
                kind load docker-image web:${{ env.VERSION }} --name ${CLUSTER_NAME}
                ;;
            esac
            echo "✅ Loaded ${{ env.SERVICE }}:${{ env.VERSION }} into Kind cluster"
          else
            echo "⚠️  Kind cluster ${CLUSTER_NAME} not found. Image built but not loaded."
            echo "Run 'act -j infra-init' to create the cluster first."
          fi
