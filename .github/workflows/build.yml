name: Build Service
on:
  push:
    paths:
      - "python/resume-agent/**"
      - "typescript/apps/server/**"
      - "typescript/apps/web/**"
      - "typescript/packages/**"
      - ".github/workflows/build.yml"
  pull_request:
    paths:
      - "python/resume-agent/**"
      - "typescript/apps/server/**"
      - "typescript/apps/web/**"
      - "typescript/packages/**"
  workflow_dispatch:
    inputs:
      service:
        description: "Service to build (resume-agent, server, web)"
        type: string
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Determine changed service
        id: detect
        if: github.event_name != 'workflow_dispatch'
        run: |
          if [ -n "${{ github.event.head_commit.message }}" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} 2>/dev/null || git diff --name-only HEAD~1 HEAD)
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          fi

          if echo "$CHANGED_FILES" | grep -q "^python/resume-agent"; then
            echo "service=resume-agent" >> $GITHUB_OUTPUT
          elif echo "$CHANGED_FILES" | grep -q "^typescript/apps/server"; then
            echo "service=server" >> $GITHUB_OUTPUT
          elif echo "$CHANGED_FILES" | grep -q "^typescript/apps/web"; then
            echo "service=web" >> $GITHUB_OUTPUT
          else
            echo "service=all" >> $GITHUB_OUTPUT
          fi

      - name: Build resume-agent
        if: |
          (github.event_name == 'workflow_dispatch' && github.event.inputs.service == 'resume-agent') ||
          (github.event_name != 'workflow_dispatch' && (steps.detect.outputs.service == 'resume-agent' || steps.detect.outputs.service == 'all'))
        run: make build
        working-directory: python/resume-agent

      - name: Build server
        if: |
          (github.event_name == 'workflow_dispatch' && github.event.inputs.service == 'server') ||
          (github.event_name != 'workflow_dispatch' && (steps.detect.outputs.service == 'server' || steps.detect.outputs.service == 'all'))
        run: make build-server
        working-directory: typescript

      - name: Build migration image
        if: |
          (github.event_name == 'workflow_dispatch' && github.event.inputs.service == 'server') ||
          (github.event_name != 'workflow_dispatch' && (steps.detect.outputs.service == 'server' || steps.detect.outputs.service == 'all'))
        run: make build-migration

      - name: Build web
        if: |
          (github.event_name == 'workflow_dispatch' && github.event.inputs.service == 'web') ||
          (github.event_name != 'workflow_dispatch' && (steps.detect.outputs.service == 'web' || steps.detect.outputs.service == 'all'))
        run: make build-web
        working-directory: typescript

      - name: Run tests
        run: |
          # Add unit tests here
          echo "Tests passed"
