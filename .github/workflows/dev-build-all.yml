name: Dev Build All
on:
  workflow_dispatch:
    inputs:
      version:
        description: "Image version/tag (applies to all services)"
        type: string
        default: "latest"

env:
  VERSION: ${{ github.event.inputs.version || 'latest' }}

jobs:
  dev-build-all:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "v1.29.2"

      - name: Configure kubectl for remote cluster
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" > ~/.kube/config
          chmod 600 ~/.kube/config
          kubectl config use-context kind-devops-demo || kubectl config current-context

      - name: Wait for registry to be ready
        run: |
          echo "Waiting for Docker registry to be ready..."
          kubectl wait --namespace docker-registry \
            --for=condition=ready pod \
            --selector=app=docker-registry \
            --timeout=120s || echo "Warning: Registry may not be ready yet"

      - name: Build resume-agent
        run: |
          cd python/resume-agent
          docker build -t resume-agent:${{ env.VERSION }} .
          echo "✅ Built resume-agent:${{ env.VERSION }}"

      - name: Build server
        run: |
          cd typescript
          docker build -t server:${{ env.VERSION }} -f apps/server/Dockerfile .
          echo "✅ Built server:${{ env.VERSION }}"

      - name: Build migration
        run: |
          docker build -t server-migration:${{ env.VERSION }} -f typescript/apps/server/Dockerfile.migration typescript
          echo "✅ Built server-migration:${{ env.VERSION }}"

      - name: Build web
        run: |
          cd typescript
          docker build -t web:${{ env.VERSION }} -f apps/web/Dockerfile \
            --build-arg VITE_SERVER_URL=https://devops-demo.local/api .
          echo "✅ Built web:${{ env.VERSION }}"

      - name: Push images to registry
        run: |
          # Start port-forward in background
          kubectl port-forward --namespace docker-registry svc/docker-registry-nodeport 5000:5000 > /dev/null 2>&1 &
          PORT_FORWARD_PID=$!
          sleep 3

          REGISTRY="localhost:5000"

          # Test registry connection
          if ! curl -f http://${REGISTRY}/v2/ > /dev/null 2>&1; then
            echo "Warning: Could not connect to registry, retrying..."
            sleep 2
          fi

          docker tag resume-agent:${{ env.VERSION }} ${REGISTRY}/resume-agent:${{ env.VERSION }}
          docker push ${REGISTRY}/resume-agent:${{ env.VERSION }}

          docker tag server:${{ env.VERSION }} ${REGISTRY}/server:${{ env.VERSION }}
          docker push ${REGISTRY}/server:${{ env.VERSION }}

          docker tag server-migration:${{ env.VERSION }} ${REGISTRY}/server-migration:${{ env.VERSION }}
          docker push ${REGISTRY}/server-migration:${{ env.VERSION }}

          docker tag web:${{ env.VERSION }} ${REGISTRY}/web:${{ env.VERSION }}
          docker push ${REGISTRY}/web:${{ env.VERSION }}

          echo "✅ Pushed all images to registry"

          # Cleanup port-forward
          kill $PORT_FORWARD_PID 2>/dev/null || true
