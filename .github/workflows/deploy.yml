name: Deploy Service
on:
  workflow_dispatch:
    inputs:
      service:
        description: "Service to deploy"
        type: choice
        options: [resume-agent, server, web]
        required: true
      environment:
        description: "Target environment"
        type: choice
        options: [production, staging, testing]
        default: staging
      version:
        description: "Image version/tag"
        type: string
        default: "latest"

env:
  NAMESPACE: ${{ github.event.inputs.environment }}
  SERVICE: ${{ github.event.inputs.service }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "v1.29.2"

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"
          terraform_wrapper: false

      - name: Create tfvars from secrets
        run: |
          mkdir -p infra/envs/${{ env.NAMESPACE }}
          cat > infra/envs/${{ env.NAMESPACE }}/terraform.tfvars << EOF
          environment = "${{ env.NAMESPACE }}"
          resume_agent_version = "${{ github.event.inputs.version }}"
          server_version = "${{ github.event.inputs.version }}"
          web_version = "${{ github.event.inputs.version }}"
          openai_api_key = "${{ secrets.OPENAI_API_KEY }}"
          database_url = "${{ secrets.DATABASE_URL }}"
          db_username = "${{ secrets.DB_USERNAME }}"
          db_password = "${{ secrets.DB_PASSWORD }}"
          db_name = "${{ secrets.DB_NAME }}"
          EOF

      - name: Build and prepare resume-agent image
        if: github.event.inputs.service == 'resume-agent'
        run: make build
        working-directory: python/resume-agent

      - name: Build and prepare server image
        if: github.event.inputs.service == 'server'
        run: make build-server
        working-directory: typescript

      - name: Build migration image
        if: github.event.inputs.service == 'server'
        run: make build-migration

      - name: Build and prepare web image
        if: github.event.inputs.service == 'web'
        run: make build-web
        working-directory: typescript

      - name: Set NAMESPACE for Makefile
        run: echo "NAMESPACE=${{ env.NAMESPACE }}" >> $GITHUB_ENV

      - name: Terraform Init
        run: make infra-init NAMESPACE=${{ env.NAMESPACE }}

      - name: Deploy resume-agent via Terraform
        if: github.event.inputs.service == 'resume-agent'
        run: |
          cd infra/envs/${{ env.NAMESPACE }} && terraform apply -var-file=terraform.tfvars -target=module.resume_agent -auto-approve

      - name: Deploy migration job
        if: github.event.inputs.service == 'server'
        run: |
          cd infra/envs/${{ env.NAMESPACE }} && terraform apply -var-file=terraform.tfvars \
            -target=module.server_migration \
            -auto-approve

      - name: Wait for migration job to complete
        if: github.event.inputs.service == 'server'
        run: |
          JOB_NAME="server-migration-$(echo ${{ github.event.inputs.version }} | tr '.' '-')"
          NAMESPACE="${{ env.NAMESPACE }}"

          echo "Waiting for migration job $JOB_NAME to complete..."

          # Wait for job to be created
          timeout=60
          elapsed=0
          while ! kubectl get job "$JOB_NAME" -n "$NAMESPACE" &>/dev/null; do
            if [ $elapsed -ge $timeout ]; then
              echo "Timeout waiting for job to be created"
              exit 1
            fi
            sleep 2
            elapsed=$((elapsed + 2))
          done

          # Wait for job to complete (success or failure)
          if kubectl wait --for=condition=complete --timeout=300s job/"$JOB_NAME" -n "$NAMESPACE"; then
            echo "Migration job completed successfully"
          else
            echo "Migration job failed or timed out"
            kubectl logs job/"$JOB_NAME" -n "$NAMESPACE" || true
            kubectl describe job/"$JOB_NAME" -n "$NAMESPACE" || true
            exit 1
          fi

      - name: Deploy server via Terraform
        if: github.event.inputs.service == 'server'
        run: |
          cd infra/envs/${{ env.NAMESPACE }} && terraform apply -var-file=terraform.tfvars -target=module.server -auto-approve

      - name: Deploy web via Terraform
        if: github.event.inputs.service == 'web'
        run: |
          cd infra/envs/${{ env.NAMESPACE }} && terraform apply -var-file=terraform.tfvars -target=module.web -auto-approve
